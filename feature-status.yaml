# Feature status inventory for carapace.
version: "1.0"
source: "migrated from TODO.md"

status_legend:
  not_verified: "Not verified — needs sanity check"
  partial: "Partial — handler exists with real logic, but some aspects stubbed"

feature_inventory_markdown: |
  ## Feature Inventory

  Comprehensive list of every feature in the system, grouped by module.
  Use for one-by-one sanity checks.

  ### Agent (`src/agent/`)

  - [ ] **Anthropic provider** — streaming, tool use, cancellation (`anthropic.rs`)
  - [ ] **OpenAI provider** — streaming, tool use, cancellation (`openai.rs`)
  - [ ] **Ollama provider** — streaming, tool use (`ollama.rs`)
  - [ ] **Gemini provider** — streaming, tool use (`gemini.rs`)
  - [ ] **Bedrock provider** — SigV4 signing, tool use, fake streaming (`bedrock.rs`)
  - [ ] **Venice AI provider** — OpenAI-compat wrapper, model prefix stripping (`venice.rs`)
  - [ ] **Provider auto-discovery** — env vars + config resolution (`factory.rs`)
  - [ ] **Base URL override** — custom API endpoints for all providers
  - [ ] **Agent execution loop** — turn loop, tool dispatch, max turns/tokens, cancellation (`mod.rs`)
  - [ ] **Agent supervisor** — panic recovery, spawn_run, timeout enforcement
  - [ ] **Tool dispatch** — built-in tools (10) + plugin tools, policy enforcement (`tool.rs`)
  - [ ] **Tool policy** — allow-all / allow-list / deny-list per config (`tool_policy.rs`)
  - [ ] **Prompt guard — preflight** — regex injection/escalation/exfiltration patterns (`prompt_guard/preflight.rs`)
  - [ ] **Prompt guard — postflight** — output content scanning with custom patterns (`prompt_guard/postflight.rs`)
  - [ ] **Inbound message classifier** — LLM-based attack classification, circuit breaker (`classifier.rs`)
  - [ ] **Output content sanitizer** — HTML/script/XSS stripping, CSP enforcement (`output_sanitizer.rs`)
  - [ ] **Exfiltration guard** — blocks private IP / localhost in tool outputs (`exfiltration.rs`)
  - [ ] **OS-level process sandbox** — Seatbelt (macOS), Landlock (Linux), rlimits (`sandbox.rs`)
  - [ ] **Channel-specific tools** — 15 platform-specific tool schemas (`channel_tools.rs`)

  ### Authentication (`src/auth/`)

  - [ ] **Token auth** — SHA-256 hashed token verification
  - [ ] **Password auth** — timing-safe password comparison
  - [ ] **Tailscale auth** — whois verification against tailnet ACLs
  - [ ] **Localhost bypass** — direct localhost connections trusted
  - [ ] **Fail-closed default** — denies by default
  - [ ] **Timing-safe comparison** — SHA-256 hash-then-compare (no length leak)

  ### Channels (`src/channels/`)

  - [ ] **Channel registry** — thread-safe channel tracking, status enum
  - [ ] **Console channel** — built-in testing channel
  - [ ] **Telegram/Discord/Slack** — via WASM plugin system (not in core)

  ### CLI (`src/cli/`)

  - [ ] **start** — launch gateway server
  - [ ] **config show/get/set/path** — configuration management
  - [ ] **status** — gateway health check via HTTP
  - [ ] **logs** — tail logs via WebSocket
  - [ ] **version** — show version + build info
  - [ ] **backup** — tar.gz archive of state directory
  - [ ] **restore** — extract backup with path traversal protection
  - [ ] **reset** — clear sessions/cron/usage/memory
  - [ ] **setup** — interactive configuration wizard
  - [ ] **pair** — device pairing initiation
  - [ ] **update** — version check and self-update
  - [ ] **tls init-ca / issue-cert / revoke-cert / show-ca** — cluster CA management

  ### Config (`src/config/`)

  - [ ] **JSON5 parsing** — comments, trailing commas
  - [ ] **$include directive** — max depth 10, circular reference detection
  - [ ] **Env var substitution** — `${VAR}` pattern replacement
  - [ ] **Config cache** — 200ms TTL in-memory cache
  - [ ] **Hot reload** — file watcher infrastructure (`watcher.rs`)
  - [ ] **Schema validation** — error/warning severity
  - [ ] **Config defaults** — fallback values
  - [ ] **Secret encryption** — AES-256-GCM at rest with PBKDF2 key derivation (`secrets.rs`)

  ### Credentials (`src/credentials/`)

  - [ ] **macOS Keychain** — keyring crate integration
  - [ ] **Linux Secret Service** — D-Bus API
  - [ ] **Windows Credential Manager** — native API
  - [ ] **Env-only fallback** — when keychain unavailable
  - [ ] **Quotas and rate limiting** — 100 per plugin, 10 writes/min
  - [ ] **Key/value size limits** — 64B key, 64KB value

  ### Cron (`src/cron/`)

  - [ ] **At schedule** — one-time execution at unix timestamp
  - [ ] **Every schedule** — interval-based recurring
  - [ ] **Cron expression** — 5-field format (min hr day mon dow)
  - [ ] **Job quotas** — max 500, LRU eviction
  - [ ] **Payload types** — SystemEvent broadcast, AgentTurn spawn
  - [ ] **Background tick loop** — async task runner
  - [ ] **Executor** — payload execution with session/run creation (`executor.rs`)

  ### Devices (`src/devices/`)

  - [ ] **Pairing state machine** — Pending/Approved/Rejected/Expired
  - [ ] **Token generation** — SHA-256 hashed, no plaintext storage
  - [ ] **Token expiry** — 90 days
  - [ ] **Quotas** — 50 devices, 25 pending, 200 tokens
  - [ ] **Persistent storage** — JSON with atomic writes

  ### Discovery (`src/discovery/`)

  - [ ] **mDNS service registration** — _moltbot._tcp.local.
  - [ ] **TXT record metadata** — version, fingerprint, device name
  - [ ] **Discovery modes** — Off/Minimal/Full
  - [ ] **Lifecycle management** — graceful shutdown

  ### Exec (`src/exec/`)

  - [ ] **Approval request creation** — async oneshot channels
  - [ ] **Approval decisions** — AllowOnce/AllowAlways/Deny
  - [ ] **Timeout support** — configurable approval wait
  - [ ] **Cleanup of expired entries**

  ### Gateway (`src/gateway/`) — feature-gated

  - [ ] **Remote gateway connection** — WebSocket + SSH tunnel transports
  - [ ] **TOFU fingerprint verification** — trust-on-first-use
  - [ ] **mTLS support** — mutual TLS with CA verification
  - [ ] **Reconnection with backoff** — exponential backoff
  - [ ] **Protocol v3** — JSON-RPC handshake

  ### Hooks (`src/hooks/`)

  - [ ] **Webhook endpoints** — /hooks/wake, /hooks/agent, /hooks/<mapping>
  - [ ] **Hook registry** — mapping storage and routing
  - [ ] **Hook authentication** — token-based auth
  - [ ] **Template evaluation** — {{expr}} replacement with JSON escaping

  ### Links (`src/links/`)

  - [ ] **URL extraction** — regex-based, code block aware
  - [ ] **HTML-to-text conversion** — html2text crate
  - [ ] **SSRF-protected fetching** — uses media module protections
  - [ ] **LRU cache** — 100 entries, 1hr TTL
  - [ ] **Title/meta extraction** — HTML metadata parsing
  - [ ] **Safe UTF-8 truncation** — char-boundary-aware

  ### Logging (`src/logging/`)

  - [ ] **JSON format** — structured production logs
  - [ ] **Plaintext format** — human-readable dev logs
  - [ ] **Output destinations** — stdout, stderr, file
  - [ ] **Log buffer layer** — ring buffer for /logs endpoint
  - [ ] **Secret masking** — redacts API keys (9 keywords)
  - [ ] **Audit logging** — security-relevant event trail

  ### Media (`src/media/`)

  - [ ] **SSRF protection** — blocks private IPs, localhost, metadata endpoints
  - [ ] **DNS rebinding defense** — post-resolution IP validation
  - [ ] **Redirect blocking** — prevents redirect-based bypass
  - [ ] **Streaming with size limits** — configurable max size
  - [ ] **Temp file storage** — TTL-based expiration with cleanup
  - [ ] **Image analysis (Claude Vision)** — Anthropic image understanding
  - [ ] **Image analysis (GPT-4 Vision)** — OpenAI image understanding
  - [ ] **Audio transcription (Whisper)** — OpenAI Whisper API
  - [ ] **Analysis caching** — .analysis.json sidecar files

  ### Messages (`src/messages/`)

  - [ ] **Outbound message pipeline** — per-channel queuing, idempotency keys
  - [ ] **Delivery status tracking** — queued/sending/sent/failed/cancelled
  - [ ] **Retry support** — retry with error tracking
  - [ ] **Delivery loop** — async message dispatch with notify

  ### Nodes (`src/nodes/`)

  - [ ] **Node pairing state machine** — Pending/Approved/Rejected/Expired
  - [ ] **Node token generation** — SHA-256 hashed
  - [ ] **Token expiry** — 30 days
  - [ ] **Quotas** — 100 nodes, 50 pending, 500 tokens
  - [ ] **Capabilities and permissions** — per-node feature negotiation
  - [ ] **Repair flow** — preserves created_at on re-pairing

  ### Plugins (`src/plugins/`)

  - [ ] **WASM component model** — wasmtime 41 runtime
  - [ ] **Ed25519 signature verification** — plugin authenticity (required by default)
  - [ ] **Plugin loader** — .wasm file loading with manifest
  - [ ] **Credential isolation** — plugin ID prefixing
  - [ ] **SSRF protection** — private IP/localhost blocking
  - [ ] **Config access enforcement** — plugins.<id>.* only
  - [ ] **Resource limits** — 64MB memory, 30s timeout, fuel-based CPU
  - [ ] **HTTP rate limiting** — 100 req/min per plugin
  - [ ] **Log rate limiting** — 1000 msg/min per plugin
  - [ ] **Permission enforcement** — declared + override permissions
  - [ ] **Tool dispatch** — tool invocation routing with collision warnings
  - [ ] **Hook dispatch** — lifecycle hook routing
  - [ ] **Webhook dispatch** — HTTP webhook routing
  - [ ] **Builtin tools** — 10 core tools

  ### Server (`src/server/`)

  - [ ] **HTTP server** — Axum framework
  - [ ] **WebSocket server** — Protocol v3, JSON-RPC
  - [ ] **Bind mode** — Loopback/LAN/WAN, localhost-only default
  - [ ] **Health endpoint** — /health status check
  - [ ] **Metrics endpoint** — /metrics Prometheus format
  - [ ] **OpenAI API compatibility** — /v1/chat/completions drop-in
  - [ ] **CSRF protection** — session-bound token validation (no fallback)
  - [ ] **Rate limiting** — per-IP quotas
  - [ ] **Resource monitoring** — CPU/memory tracking
  - [ ] **Content Security Policy** — CSP headers
  - [ ] **Control API** — status, channels, config handlers
  - [ ] **Graceful shutdown** — 30s drain period

  #### WebSocket Handlers

  - [ ] **agent.run / agent.cancel** — LLM execution + cancellation
  - [ ] **session.create/load/list/fork/rename/delete/switch** — session management
  - [ ] **config.get/update/reload/validate** — configuration
  - [ ] **exec.approve/deny/list** — exec approval workflow
  - [ ] **system.info** — system information
  - [ ] **logs.tail** — streaming log buffer
  - [ ] **skills.status** — skill listing
  - [ ] **cron.*** — cron job CRUD + lifecycle
  - [ ] **tts.speak / tts.voices** — text-to-speech
  - [ ] **voicewake.get / voicewake.keywords** — wake word config
  - [~] **config.schema** — stub: returns minimal placeholder
  - [~] **system.last-heartbeat / set-heartbeats** — stub: returns null / discards
  - [~] **system.wake** — stub: accepts target, no action
  - [~] **talk.devices** — stub: returns hardcoded device list
  - [~] **tts.stop** — stub: returns stopped=true without stopping
  - [~] **voicewake.test** — stub: returns hardcoded detection=false
  - [~] **wizard** — framework works, collected config not applied

  ### Sessions (`src/sessions/`)

  - [ ] **JSONL format** — append-friendly history
  - [ ] **Compaction** — truncate old messages
  - [ ] **HMAC integrity** — SHA-256 HMAC (metadata only, not history)
  - [ ] **Session archiving + restoration**
  - [ ] **Session filters** — list/search by criteria
  - [ ] **File locking** — concurrent-safe operations
  - [ ] **Retention policies** — age-based cleanup
  - [ ] **Scoping** — multi-tenant session isolation

  ### Tailscale (`src/tailscale/`)

  - [ ] **Tailscale serve** — tailnet HTTPS proxy
  - [ ] **Tailscale funnel** — public internet exposure
  - [ ] **CLI wrapper** — async command execution
  - [ ] **Status parsing** — JSON status extraction
  - [ ] **Lifecycle management** — setup / wait / teardown

  ### TLS (`src/tls/`)

  - [ ] **Self-signed cert generation** — rcgen, 365-day validity
  - [ ] **Auto-generation on startup**
  - [ ] **TLS certificate loading** — PEM format
  - [ ] **SHA-256 fingerprint** — TOFU verification
  - [ ] **mTLS server config** — client cert verification
  - [ ] **mTLS client config** — presents node certificate
  - [ ] **Cluster CA generation** — ECDSA P-256 (`ca.rs`)
  - [ ] **Node certificate issuance** — signed by cluster CA
  - [ ] **Certificate revocation (CRL)** — CRL generation and updates (advisory only, not enforced by rustls)
  - [ ] **Restrictive key permissions** — 0600 on private keys

  ### Usage (`src/usage/`)

  - [ ] **Daily/monthly summaries** — aggregated usage data
  - [ ] **Session usage tracking** — per-session totals
  - [ ] **Provider/model breakdown** — per-provider and per-model aggregation
  - [ ] **Cost calculation** — per-million-token pricing
  - [ ] **Persistent JSON storage** — pretty JSON format
  - [ ] **Enable/disable tracking** — privacy control

  ### Tests & CI

  - [ ] **Unit tests** — 4,614 tests across all modules
  - [ ] **Integration tests** — tests/*.rs
  - [ ] **Golden snapshot tests** — insta-based snapshot testing
  - [ ] **Cross-platform CI** — Linux, macOS, Windows matrix
  - [ ] **MSRV enforcement** — Rust 1.93
  - [ ] **Security scanning** — cargo-audit, cargo-deny, gitleaks, trivy, cargo-geiger
